---
# FILE: /opt/ansible-k3s-cluster/playbooks/post-power-on-checklist.yml
# PURPOSE:
#   Cluster-wide verification after full chassis power-on.
#   Confirms node reachability, DNS, SSH, clocks, network, storage,
#   and distccd service state.
#
# NOTES:
#   - ASCII-only, nano-safe, no tabs.
#   - No builder-local pump-mode or tmpfs logic.
#   - Deterministic, 2AM-safe, future-maintainer-safe.
# =====================================================================

- name: Post-power-on cluster verification
  hosts: all
  gather_facts: false

  tasks:

    # ---------------------------------------------------------------
    # 1. Verify node reachability
    # ---------------------------------------------------------------
    - name: Ping all nodes
      ansible.builtin.ping:

    # ---------------------------------------------------------------
    # 2. Verify DNS resolution
    # ---------------------------------------------------------------
    - name: Check DNS resolution for each host
      ansible.builtin.command: "getent hosts {{ inventory_hostname }}"
      register: dns_result
      failed_when: false
      changed_when: false

    - name: Display DNS result
      ansible.builtin.debug:
        msg: "DNS: {{ dns_result.stdout }}"

    # ---------------------------------------------------------------
    # 3. Verify SSH access (implicit via Ansible)
    # ---------------------------------------------------------------
    - name: Confirm SSH identity
      ansible.builtin.command: "id"
      register: id_result
      failed_when: false
      changed_when: false

    - name: Display SSH identity
      ansible.builtin.debug:
        msg: "SSH identity: {{ id_result.stdout }}"

    # ---------------------------------------------------------------
    # 4. Verify system clocks
    # ---------------------------------------------------------------
    - name: Show system time
      ansible.builtin.command: "date"
      register: date_result
      failed_when: false
      changed_when: false

    - name: Display system time
      ansible.builtin.debug:
        msg: "Time: {{ date_result.stdout }}"

    # ---------------------------------------------------------------
    # 5. Verify network health
    # ---------------------------------------------------------------
    - name: Show uptime
      ansible.builtin.command: "uptime"
      register: uptime_result
      failed_when: false
      changed_when: false

    - name: Display uptime
      ansible.builtin.debug:
        msg: "Uptime: {{ uptime_result.stdout }}"

    - name: Show IPv4 addresses
      ansible.builtin.command: "ip -4 addr"
      register: ip_result
      failed_when: false
      changed_when: false

    - name: Display IPv4 addresses
      ansible.builtin.debug:
        msg: "IPv4: {{ ip_result.stdout }}"

    # ---------------------------------------------------------------
    # 6. Verify storage health
    # ---------------------------------------------------------------
    - name: Show root filesystem usage
      ansible.builtin.command: "df -h /"
      register: df_result
      failed_when: false
      changed_when: false

    - name: Display root filesystem usage
      ansible.builtin.debug:
        msg: "Root FS: {{ df_result.stdout }}"

    # ---------------------------------------------------------------
    # 7. Verify distccd service state (workers only)
    # ---------------------------------------------------------------
    - name: Check distccd service state
      ansible.builtin.command: "systemctl is-active distccd"
      register: distccd_status
      failed_when: false
      changed_when: false

    - name: Display distccd status
      ansible.builtin.debug:
        msg: "distccd status: {{ distccd_status.stdout }}"
