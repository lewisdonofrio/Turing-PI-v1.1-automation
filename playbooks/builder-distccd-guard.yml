# /opt/ansible-k3s-cluster/playbooks/builder-distccd-guard.yml
# Purpose: Ensure builder is clean and correct for DISTCC BUILD MODE.
# Behavior: Disables distccd, enforces tmpfs unit integrity, enforces environment.
# Author: Lewis Donofrio
# Notes: Safe to run at 1am. ASCII-only. Idempotent. Self-healing.

- name: Guard builder state for distcc
  hosts: builder
  become: true
  gather_facts: false

  tasks:

    - name: Stop distccd on builder
      ansible.builtin.service:
        name: distccd
        state: stopped
      failed_when: false

    - name: Disable distccd on builder
      ansible.builtin.command: systemctl disable distccd
      failed_when: false

    - name: Ensure tmpfs mountpoint exists
      ansible.builtin.file:
        path: /tmp/kernel-build
        state: directory
        mode: '0755'

    - name: Install canonical tmpfs mount unit
      ansible.builtin.template:
        src: /opt/ansible-k3s-cluster/templates/tmp-kernel-build.mount.j2
        dest: /etc/systemd/system/tmp-kernel\x2dbuild.mount
        mode: '0644'

    - name: Reload systemd units
      ansible.builtin.command: systemctl daemon-reload

    - name: Enable tmpfs mount unit
      ansible.builtin.command: systemctl enable 'tmp-kernel\x2dbuild.mount'

    - name: Start tmpfs mount unit
      ansible.builtin.command: systemctl start 'tmp-kernel\x2dbuild.mount'

    - name: Enforce builder distcc environment
      ansible.builtin.copy:
        dest: /etc/profile.d/builder-distcc.sh
        mode: '0644'
        content: |
          # Builder distcc environment
          export PATH="/usr/lib/distcc/bin:/usr/lib/distcc:/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin"
          export HOSTCC="/usr/bin/gcc"
          export HOSTCXX="/usr/bin/g++"
          export DISTCC_HOSTS="kubenode2.home.lab/6 kubenode3.home.lab/6 kubenode4.home.lab/6 kubenode5.home.lab/6 kubenode6.home.lab/6 kubenode7.home.lab/6"

    - name: Report builder guard state
      ansible.builtin.debug:
        msg:
          - "Builder distccd disabled."
          - "Builder tmpfs unit verified and active."
          - "Builder environment enforced."
