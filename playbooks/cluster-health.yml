# /opt/ansible-k3s-cluster/playbooks/cluster-health.yml
# Purpose: Perform a deterministic, cluster-wide health check.
# Behavior:
#   - Validate SSH reachability
#   - Check distccd status on workers
#   - Check include-server on builder
#   - Inspect cc1 activity
#   - Check load, memory, disk, and kernel version
#   - Produce a clean cluster health summary
# Notes:
#   - ASCII-only, nano-safe, idempotent.

---

# =============================================================================
# Phase 1: SSH reachability
# =============================================================================
- name: Verify SSH connectivity
  hosts: all
  become: false
  gather_facts: false

  tasks:

    - name: Check SSH availability
      ansible.builtin.shell: |
        echo "ssh ok"
      register: ssh_check
      changed_when: false

    - name: Report SSH status
      ansible.builtin.debug:
        msg: "SSH reachable on {{ inventory_hostname }}"

# =============================================================================
# Phase 2: Builder health (pump-mode)
# =============================================================================
- name: Check builder pump-mode health
  hosts: builder
  become: false
  gather_facts: false

  tasks:

    - name: Check include-server
      ansible.builtin.shell: |
        pgrep -f include-server && echo "running" || echo "stopped"
      register: include_server_state
      changed_when: false

    - name: Report include-server state
      ansible.builtin.debug:
        msg: "include-server: {{ include_server_state.stdout }}"

# =============================================================================
# Phase 3: Worker health (distccd + cc1)
# =============================================================================
- name: Check worker distccd and cc1 activity
  hosts: workers
  become: true
  gather_facts: false

  tasks:

    - name: Check distccd service
      ansible.builtin.shell: |
        systemctl is-active distccd || echo "inactive"
      register: distccd_state
      changed_when: false

    - name: Report distccd state
      ansible.builtin.debug:
        msg: "distccd on {{ inventory_hostname }}: {{ distccd_state.stdout }}"

    - name: Check for cc1 processes
      ansible.builtin.shell: |
        pgrep -a cc1 || echo "none"
      register: cc1_state
      changed_when: false

    - name: Report cc1 activity
      ansible.builtin.debug:
        msg: "cc1 on {{ inventory_hostname }}: {{ cc1_state.stdout }}"

# =============================================================================
# Phase 4: System metrics (load, memory, disk, kernel)
# =============================================================================
- name: Collect system metrics
  hosts: all
  become: true
  gather_facts: false

  tasks:

    - name: Get load average
      ansible.builtin.shell: |
        awk '{print $1,$2,$3}' /proc/loadavg
      register: loadavg
      changed_when: false

    - name: Get memory summary
      ansible.builtin.shell: |
        free -h | grep 'Mem:'
      register: meminfo
      changed_when: false

    - name: Get disk usage
      ansible.builtin.shell: |
        df -h /
      register: diskinfo
      changed_when: false

    - name: Get kernel version
      ansible.builtin.shell: |
        uname -r
      register: kernelver
      changed_when: false

    - name: Report system metrics
      ansible.builtin.debug:
        msg:
          - "Load: {{ loadavg.stdout }}"
          - "Memory: {{ meminfo.stdout }}"
          - "Disk: {{ diskinfo.stdout_lines }}"
          - "Kernel: {{ kernelver.stdout }}"

# =============================================================================
# Phase 5: Cluster health summary
# =============================================================================
- name: Cluster health summary
  hosts: all
  become: false
  gather_facts: false

  tasks:

    - name: Report node health
      ansible.builtin.debug:
        msg: "Node {{ inventory_hostname }} health check complete"
