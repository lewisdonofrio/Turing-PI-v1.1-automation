# /opt/ansible-k3s-cluster/playbooks/distcc-sanity-check.yml
# Purpose: Verify each worker accepts distcc jobs individually.
# Behavior: Builder-only. Safe to run at 2am.
# Author: Lewis Donofrio

- name: Distcc per-worker sanity check
  hosts: builder
  become: true
  gather_facts: false

  vars:
    workers:
      - kubenode2.home.lab
      - kubenode3.home.lab
      - kubenode4.home.lab
      - kubenode5.home.lab
      - kubenode6.home.lab
      - kubenode7.home.lab

  tasks:

    - name: Create slower test source file
      ansible.builtin.copy:
        dest: /tmp/distcc_test.c
        mode: '0644'
        content: |
          int main() {
              volatile int x = 0;
              for (int i = 0; i < 50000000; i++) { x += i; }
              return x;
          }

    - name: Test each worker individually
      ansible.builtin.shell: |
        echo "=== ENVIRONMENT FOR {{ item }} ==="

        # Correct wrapper directory
        export PATH="/usr/lib/distcc/bin:$PATH"
        export CC="distcc gcc"
        export DISTCC_HOSTS="{{ item }}"

        echo "PATH=$PATH"
        echo "CC=$CC"
        echo "DISTCC_HOSTS=$DISTCC_HOSTS"

        echo "=== COMPILING ON {{ item }} ==="
        distcc gcc -c /tmp/distcc_test.c -o /tmp/distcc_test.o &

        # Give distcc time to dispatch the job
        sleep 1

        echo "=== DISTCCMON OUTPUT ==="
        distccmon-text 1

        # Hard fail if worker did not appear
        if ! distccmon-text 1 | grep -q "{{ item }}"; then
          echo "FAIL: {{ item }} did NOT accept job"
          exit 1
        fi

        echo "OK: {{ item }} accepted job"
      loop: "{{ workers }}"
      register: results
      args:
        executable: /bin/bash

    - name: Show raw stdout for each worker
      ansible.builtin.debug:
        msg: "{{ item.stdout }}"
      loop: "{{ results.results }}"
