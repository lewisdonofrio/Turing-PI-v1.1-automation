# /opt/ansible-k3s-cluster/playbooks/mode-status.yml
# Purpose: Report current cluster mode and service states.
# Behavior: Checks k3s, distccd, and tmpfs mount status.
# Author: Lewis Donofrio
# Notes: Safe to run at 2am. Idempotent. ASCII-only.

- name: Check builder status
  hosts: builder
  become: true
  gather_facts: false
  tasks:
    - name: Check k3s-server state
      ansible.builtin.command: systemctl is-active k3s
      register: builder_k3s
      failed_when: false

    - name: Check distccd state
      ansible.builtin.command: systemctl is-active distccd
      register: builder_distccd
      failed_when: false

    - name: Check tmpfs mount state
      ansible.builtin.command: systemctl is-active 'tmp-kernel\x2dbuild.mount'
      register: builder_tmpfs
      failed_when: false

    - name: Report builder status
      ansible.builtin.debug:
        msg:
          - "Builder k3s-server: {{ builder_k3s.stdout | default('unknown') }}"
          - "Builder distccd: {{ builder_distccd.stdout | default('unknown') }}"
          - "Builder tmpfs mount: {{ builder_tmpfs.stdout | default('unknown') }}"

- name: Check worker status
  hosts: workers
  become: true
  gather_facts: false
  tasks:
    - name: Check k3s-agent state
      ansible.builtin.command: systemctl is-active k3s-agent
      register: worker_k3s
      failed_when: false

    - name: Check distccd state
      ansible.builtin.command: systemctl is-active distccd
      register: worker_distccd
      failed_when: false

    - name: Report worker status
      ansible.builtin.debug:
        msg:
          - "Worker {{ inventory_hostname }} k3s-agent: {{ worker_k3s.stdout | default('unknown') }}"
          - "Worker {{ inventory_hostname }} distccd: {{ worker_distccd.stdout | default('unknown') }}"
