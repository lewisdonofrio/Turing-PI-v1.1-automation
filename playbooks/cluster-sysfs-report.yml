# =============================================================================
# File: /opt/ansible-k3s-cluster/cluster-sysfs-report.yml
# =============================================================================
# Purpose:
#   Generate a cluster-wide sysfs report including:
#     - CPU frequency scaling
#     - Thermal zones
#     - Block device attributes
#     - Kernel tunables exposed via sysfs
#
# Usage:
#   ansible-playbook \
#     -i /opt/ansible-k3s-cluster/inventory/hosts \
#     /opt/ansible-k3s-cluster/cluster-sysfs-report.yml
#
# Notes:
#   - Useful for diagnosing thermal throttling, CPU scaling issues, and
#     hardware inconsistencies across nodes.
# =============================================================================

---
- hosts: k3s_cluster
  become: yes

  tasks:
    - name: Show CPU frequency scaling
      shell: cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2>/dev/null
      register: cpu_freq

    - name: Show thermal zones
      shell: ls /sys/class/thermal/ 2>/dev/null
      register: thermal

    - name: Show block device attributes
      shell: ls /sys/block/ 2>/dev/null
      register: block

    - name: Display sysfs report
      debug:
        msg:
          - "CPU Frequency: {{ cpu_freq.stdout }}"
          - "Thermal Zones: {{ thermal.stdout }}"
          - "Block Devices: {{ block.stdout }}"
