# /opt/ansible-k3s-cluster/playbooks/builder-mode.yml
# Purpose: Enter BUILD MODE for distributed kernel builds.
# Behavior: Stops all k3s services and prepares builder + workers.
# Author: Lewis Donofrio
# Notes: Safe to run at 2am. Idempotent.

- name: Stop k3s-server on builder
  hosts: builder
  become: true
  gather_facts: false
  tasks:
    - name: Stop k3s-server
      ansible.builtin.service:
        name: k3s
        state: stopped
      failed_when: false

- name: Stop k3s-agent on workers
  hosts: workers
  become: true
  gather_facts: false
  tasks:
    - name: Stop k3s-agent
      ansible.builtin.service:
        name: k3s-agent
        state: stopped
      failed_when: false

# --- distcc bootstrap ---
- import_playbook: distccd-bootstrap.yml

# --- distcc validation ---
- import_playbook: cluster-distcc-validate.yml

# --- distcc smoketest ---
- import_playbook: cluster-distcc-smoketest.yml

# --- Builder environment enforcement ---
- name: Enforce builder PATH + CC environment
  hosts: builder
  become: true
  gather_facts: false
  tasks:
    - name: Write builder distcc environment file
      ansible.builtin.copy:
        dest: /etc/profile.d/builder-distcc.sh
        mode: '0644'
        content: |
          # Builder distcc environment
          export PATH="/usr/lib/distcc:/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/sbin:/sbin:/bin"
          export CC="distcc gcc"
          export HOSTCC="distcc gcc"
          export HOSTCXX="distcc g++"
          export MAKEFLAGS="CC='distcc gcc'"
          export DISTCC_HOSTS="kubenode2.home.lab kubenode3.home.lab kubenode4.home.lab kubenode5.home.lab kubenode6.home.lab kubenode7.home.lab"

- name: Report builder mode active
  hosts: builder
  gather_facts: false
  tasks:
    - ansible.builtin.debug:
        msg: "BUILD MODE active: k3s stopped, distcc validated, environment enforced."
