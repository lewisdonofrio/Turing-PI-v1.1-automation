# /opt/ansible-k3s-cluster/playbooks/cluster-distcc-saturation.yml
# Purpose: Stress-test distcc and pump-mode across the cluster.
# Behavior: Performs a high-concurrency distributed compile, monitors worker
#           participation, detects fallback-to-local, and reports saturation.
# Notes: Read-only except for temporary files. ASCII-only. Idempotent.

---

# =============================================================================
# Builder saturation test
# =============================================================================
- name: Distcc saturation test from builder
  hosts: builder
  become: false
  gather_facts: false

  vars_files:
    - /opt/ansible-k3s-cluster/manifest/distcc-hosts.yml

  vars:
    sat_dir: /tmp/distcc-saturation
    sat_source: /tmp/distcc-saturation/test.c
    sat_output: /tmp/distcc-saturation/test.o
    distcc_hosts_env: "{{ distcc_hosts | join(' ') }}"
    job_count: 32

  tasks:

    # -------------------------------------------------------------------------
    # Pump-mode readiness
    # -------------------------------------------------------------------------
    - name: Validate pump-mode health
      ansible.builtin.shell: /home/builder/scripts/pumpctl health
      register: pump_health
      changed_when: false
      failed_when: pump_health.rc != 0

    - name: Report pump-mode health
      ansible.builtin.debug:
        msg: "pumpctl health: OK"

    # -------------------------------------------------------------------------
    # Prepare saturation directory
    # -------------------------------------------------------------------------
    - name: Create saturation directory
      ansible.builtin.file:
        path: "{{ sat_dir }}"
        state: directory
        mode: '0755'

    - name: Install test C source
      ansible.builtin.copy:
        dest: "{{ sat_source }}"
        mode: '0644'
        content: |
          int main(void) {
              return 0;
          }

    - name: Clean previous artifacts
      ansible.builtin.file:
        path: "{{ sat_output }}"
        state: absent

    # -------------------------------------------------------------------------
    # High-concurrency distributed compile
    # -------------------------------------------------------------------------
    - name: Run high-concurrency distcc compile
      ansible.builtin.shell: |
        /usr/bin/env \
        PATH="/usr/bin:/bin" \
        DISTCC_HOSTS="{{ distcc_hosts_env }}" \
        DISTCC_VERBOSE=1 \
        distcc -j {{ job_count }} -c "{{ sat_source }}" -o "{{ sat_output }}" 2>&1
      args:
        chdir: "{{ sat_dir }}"
        executable: /bin/bash
      register: sat_compile
      changed_when: false

    - name: Report saturation compile output
      ansible.builtin.debug:
        msg: "{{ sat_compile.stdout_lines }}"

    # -------------------------------------------------------------------------
    # Worker participation analysis
    # -------------------------------------------------------------------------
    - name: Extract worker hosts from verbose output
      ansible.builtin.shell: |
        echo "{{ sat_compile.stdout }}" | grep -oE 'distcc

\[.*\]

 [^ ]+:3632' | awk '{print $NF}' | sed 's/:3632//'
      register: worker_hosts
      changed_when: false

    - name: Report worker participation
      ansible.builtin.debug:
        msg:
          - "Workers used: {{ worker_hosts.stdout_lines }}"
          - "Worker count: {{ worker_hosts.stdout_lines | length }}"

    # -------------------------------------------------------------------------
    # Fallback detection
    # -------------------------------------------------------------------------
    - name: Detect fallback to localhost
      ansible.builtin.shell: |
        echo "{{ sat_compile.stdout }}" | grep -q "localhost" && echo "fallback" || echo "ok"
      register: fallback_check
      changed_when: false

    - name: Report fallback state
      ansible.builtin.debug:
        msg: "Fallback to localhost: {{ fallback_check.stdout }}"

# =============================================================================
# Worker saturation monitoring
# =============================================================================
- name: Monitor worker saturation
  hosts: workers
  become: true
  gather_facts: false

  tasks:

    - name: Check cc1 processes
      ansible.builtin.shell: pgrep -a cc1 || true
      register: cc1_processes
      changed_when: false

    - name: Report cc1 activity
      ansible.builtin.debug:
        msg: "cc1 activity: {{ cc1_processes.stdout | default('none') }}"

    - name: Report worker load average
      ansible.builtin.shell: cat /proc/loadavg
      register: worker_load
      changed_when: false

    - name: Report worker load
      ansible.builtin.debug:
        msg: "Load average: {{ worker_load.stdout }}"

    - name: Tail last 20 lines of distccd log
      ansible.builtin.shell: tail -n 20 /var/log/distccd/distccd.log || true
      register: distccd_log
      changed_when: false

    - name: Report distccd log tail
      ansible.builtin.debug:
        msg: "{{ distccd_log.stdout_lines }}"
