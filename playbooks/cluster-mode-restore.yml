# /opt/ansible-k3s-cluster/playbooks/cluster-mode-restore.yml
# Purpose: Force CLUSTER MODE after partial or failed transitions.
# Behavior: Stops distccd, disables tmpfs mount, restores all k3s services.
# Author: Lewis Donofrio
# Notes: Safe to run at 2am. Idempotent. ASCII-only.

- name: Stop distccd on all nodes
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: Stop distccd service
      ansible.builtin.service:
        name: distccd
        state: stopped
      failed_when: false

    - name: Disable distccd service
      ansible.builtin.command: systemctl disable distccd
      failed_when: false

# --- tmpfs teardown (builder only) ---
- name: Disable tmpfs mount for kernel builds
  hosts: builder
  become: true
  gather_facts: false
  tasks:
    - name: Stop tmpfs mount unit
      ansible.builtin.command: systemctl stop 'tmp-kernel\x2dbuild.mount'
      failed_when: false

    - name: Disable tmpfs mount unit
      ansible.builtin.command: systemctl disable 'tmp-kernel\x2dbuild.mount'
      failed_when: false

# --- k3s restore ---
- name: Restore k3s-server on builder
  hosts: builder
  become: true
  gather_facts: false
  tasks:
    - name: Start k3s-server
      ansible.builtin.service:
        name: k3s
        state: started
      failed_when: false

- name: Restore k3s-agent on workers
  hosts: workers
  become: true
  gather_facts: false
  tasks:
    - name: Start k3s-agent
      ansible.builtin.service:
        name: k3s-agent
        state: started
      failed_when: false

- name: Report cluster mode restored
  hosts: builder
  gather_facts: false
  tasks:
    - ansible.builtin.debug:
        msg: "CLUSTER MODE restored: distccd stopped, tmpfs disabled, k3s services running."
