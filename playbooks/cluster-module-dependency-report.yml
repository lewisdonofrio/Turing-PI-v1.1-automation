# =============================================================================
# File: /opt/ansible-k3s-cluster/cluster-module-dependency-report.yml
# =============================================================================
# Purpose:
#   Generate a cluster-wide kernel module dependency report including:
#     - Module dependency chains
#     - Missing dependencies
#     - Modules loaded vs. modules available
#
# Usage:
#   ansible-playbook \
#     -i /opt/ansible-k3s-cluster/inventory/hosts \
#     /opt/ansible-k3s-cluster/cluster-module-dependency-report.yml
#
# Notes:
#   - Useful for diagnosing module load failures and kernel ABI mismatches.
# =============================================================================

---
- hosts: k3s_cluster
  become: yes

  tasks:
    - name: Show module dependency list
      shell: modprobe --show-depends overlay 2>/dev/null || true
      register: overlay_dep

    - name: Show module dependency list for br_netfilter
      shell: modprobe --show-depends br_netfilter 2>/dev/null || true
      register: br_dep

    - name: Display module dependency report
      debug:
        msg:
          - "overlay dependencies: {{ overlay_dep.stdout }}"
          - "br_netfilter dependencies: {{ br_dep.stdout }}"
