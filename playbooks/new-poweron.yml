# /opt/ansible-k3s-cluster/playbooks/poweron.yml
# Purpose: Bring the entire k3s + distcc cluster online in a deterministic sequence.
# Notes:
#   - ASCII-only, nano-safe, idempotent.
#   - Pump-mode startup is builder-local and NOT handled here.
#   - This playbook enforces cluster-wide invariants only.

---

# =============================================================================
# Phase 1: Verify SSH reachability
# =============================================================================
- name: Verify SSH connectivity
  hosts: all
  become: false
  gather_facts: false

  tasks:
    - name: Check SSH availability
      ansible.builtin.shell: echo "ssh ok"
      register: ssh_check
      changed_when: false

    - name: Report SSH status
      ansible.builtin.debug:
        msg: "SSH reachable on {{ inventory_hostname }}"

# =============================================================================
# Phase 2: Enforce distcc hostfile and remove legacy pollution
# =============================================================================
- name: Enforce distcc configuration
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Ensure /etc/distcc/hosts is correct
      ansible.builtin.copy:
        dest: /etc/distcc/hosts
        content: |
          kubenode2/4
          kubenode3/4
          kubenode4/4
          kubenode5/4
          kubenode6/4
          kubenode7/4
        owner: root
        group: root
        mode: '0644'

    - name: Remove legacy profile scripts
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/profile.d/distcc.sh
        - /etc/profile.d/distcc-pump.sh
        - /etc/profile.d/builder-distcc.sh

# =============================================================================
# Phase 3: Prepare worker build directories (persistent storage only)
# =============================================================================
- name: Prepare worker build environment
  hosts: workers
  become: true
  gather_facts: false

  vars:
    build_dir: /var/tmp/distcc-build

  tasks:
    - name: Create persistent build directory
      ansible.builtin.file:
        path: "{{ build_dir }}"
        state: directory
        mode: '0755'

    - name: Report build directory status
      ansible.builtin.debug:
        msg: "Persistent build directory ready on {{ inventory_hostname }} at {{ build_dir }}"

# =============================================================================
# Phase 4: Start distccd on workers
# =============================================================================
- name: Start distccd on workers
  hosts: workers
  become: true
  gather_facts: false

  tasks:
    - name: Ensure distccd service is running
      ansible.builtin.service:
        name: distccd
        state: started
        enabled: true

    - name: Report distccd status
      ansible.builtin.debug:
        msg: "distccd running on {{ inventory_hostname }}"

# =============================================================================
# Phase 5: Cluster readiness summary
# =============================================================================
- name: Cluster power-on summary
  hosts: all
  become: false
  gather_facts: false

  tasks:
    - name: Report node online
      ansible.builtin.debug:
        msg: "Node {{ inventory_hostname }} is online and ready"
