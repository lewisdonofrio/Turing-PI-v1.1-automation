# /opt/ansible-k3s-cluster/playbooks/cluster-reset.yml
# Purpose: Reset the entire distcc + pump-mode build cluster to a clean state.
# Behavior:
#   - Stop include-server on builder
#   - Stop distccd on workers
#   - Kill lingering cc1 processes
#   - Clear persistent build directories
#   - Clear builder build logs and build outputs
#   - Produce a clean cluster reset summary
# Notes:
#   - ASCII-only, nano-safe, idempotent.
#   - Does NOT delete kernel source trees.
#   - Safe to run repeatedly.

---

# =============================================================================
# Phase 1: Stop pump-mode include-server on builder
# =============================================================================
- name: Stop include-server on builder
  hosts: builder
  become: false
  gather_facts: false

  tasks:

    - name: Stop include-server if running
      ansible.builtin.shell: |
        pkill -f include-server || true
      changed_when: false

    - name: Verify include-server stopped
      ansible.builtin.shell: |
        pgrep -f include-server && echo "running" || echo "stopped"
      register: include_server_state
      changed_when: false

    - name: Report include-server state
      ansible.builtin.debug:
        msg: "include-server: {{ include_server_state.stdout }}"

# =============================================================================
# Phase 2: Stop distccd on workers
# =============================================================================
- name: Stop distccd on workers
  hosts: workers
  become: true
  gather_facts: false

  tasks:

    - name: Stop distccd service
      ansible.builtin.service:
        name: distccd
        state: stopped
      register: distccd_stop

    - name: Report distccd stop state
      ansible.builtin.debug:
        msg: "distccd stopped on {{ inventory_hostname }}"

# =============================================================================
# Phase 3: Kill lingering cc1 processes on workers
# =============================================================================
- name: Kill lingering cc1 processes
  hosts: workers
  become: true
  gather_facts: false

  tasks:

    - name: Kill cc1 processes
      ansible.builtin.shell: |
        pkill -f cc1 || true
      changed_when: false

    - name: Verify cc1 is gone
      ansible.builtin.shell: |
        pgrep -a cc1 || echo "none"
      register: cc1_state
      changed_when: false

    - name: Report cc1 state
      ansible.builtin.debug:
        msg: "cc1 on {{ inventory_hostname }}: {{ cc1_state.stdout }}"

# =============================================================================
# Phase 4: Clear worker build directories (persistent storage only)
# =============================================================================
- name: Clear worker build directories
  hosts: workers
  become: true
  gather_facts: false

  vars:
    build_dir: /var/tmp/distcc-build

  tasks:

    - name: Remove build directory contents
      ansible.builtin.file:
        path: "{{ build_dir }}"
        state: absent

    - name: Recreate empty build directory
      ansible.builtin.file:
        path: "{{ build_dir }}"
        state: directory
        mode: '0755'

    - name: Report build directory reset
      ansible.builtin.debug:
        msg: "Build directory reset on {{ inventory_hostname }} at {{ build_dir }}"

# =============================================================================
# Phase 5: Clear builder build logs and build outputs
# =============================================================================
- name: Clear builder build artifacts
  hosts: builder
  become: false
  gather_facts: false

  vars:
    build_logs: /home/builder/build-logs
    build_output: /home/builder/build-output

  tasks:

    - name: Clear build logs
      ansible.builtin.file:
        path: "{{ build_logs }}"
        state: absent

    - name: Recreate build logs directory
      ansible.builtin.file:
        path: "{{ build_logs }}"
        state: directory
        mode: '0755'

    - name: Clear build output directory
      ansible.builtin.file:
        path: "{{ build_output }}"
        state: absent

    - name: Recreate build output directory
      ansible.builtin.file:
        path: "{{ build_output }}"
        state: directory
        mode: '0755'

    - name: Report builder cleanup
      ansible.builtin.debug:
        msg: "Builder logs and output directories reset"

# =============================================================================
# Phase 6: Cluster reset summary
# =============================================================================
- name: Cluster reset summary
  hosts: all
  become: false
  gather_facts: false

  tasks:

    - name: Report node reset state
      ansible.builtin.debug:
        msg: "Node {{ inventory_hostname }} reset complete"
