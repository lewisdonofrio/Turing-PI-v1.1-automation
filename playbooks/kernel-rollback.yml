# =====================================================================
#  /opt/ansible-k3s-cluster/playbooks/kernel-rollback.yml
# =====================================================================
#  Purpose:
#    Roll back cluster nodes to a previous kernel using one of two
#    supported rollback sources:
#
#      1. Pacman cache rollback (automatic)
#         - Installs previous kernel packages from /var/cache/pacman/pkg
#
#      2. Backup directory rollback (manual)
#         - Restores /boot and /usr/lib/modules from a backup directory
#         - Backups created by kernel-backup.yml
#
#    Supports staged rollback and is safe to run on any subset of nodes.
#
#  Notes:
#    - ASCII-only, nano-safe, deterministic, idempotent.
#    - No tabs, no Unicode, no timestamps.
#    - Does NOT install new kernels or verify post-reboot state.
# =====================================================================

- hosts: kernel_targets
  become: yes
  gather_facts: false

  vars_prompt:
    - name: rollback_mode
      prompt: |
        Select rollback mode:
          1 = Pacman cache rollback (automatic)
          2 = Backup directory rollback (manual)
        Enter 1 or 2
      private: no

  vars:
    pacman_cache: "/var/cache/pacman/pkg"
    boot_dir: "/boot"
    modules_dir: "/usr/lib/modules"
    kernel_safe_path: "/usr/bin:/usr/local/bin:/usr/sbin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl:{{ ansible_env.PATH }}"

  environment:
    PATH: "{{ kernel_safe_path }}"

  tasks:

    #####################################################################
    # 1. VALIDATE MODE AND PROMPT FOR BACKUP DIRECTORY IF NEEDED
    #####################################################################

    - name: Validate rollback_mode is 1 or 2
      ansible.builtin.fail:
        msg: "rollback_mode must be 1 or 2"
      when: rollback_mode not in ['1', '2']

    - name: Prompt for rollback_dir only when mode 2 and not provided
      ansible.builtin.pause:
        prompt: "Enter full path to kernel backup directory"
      register: rollback_dir_prompt
      when:
        - rollback_mode == '2'
        - rollback_dir is not defined

    - name: Set rollback_dir from prompt
      ansible.builtin.set_fact:
        rollback_dir: "{{ rollback_dir_prompt.user_input }}"
      when:
        - rollback_mode == '2'
        - rollback_dir is not defined

    - name: Validate rollback_dir exists when mode 2
      ansible.builtin.stat:
        path: "{{ rollback_dir }}"
      register: rollback_stat
      when: rollback_mode == '2'

    - name: Abort if rollback directory is missing (mode 2)
      ansible.builtin.fail:
        msg: "Rollback directory {{ rollback_dir }} does not exist."
      when:
        - rollback_mode == '2'
        - not rollback_stat.stat.exists

    #####################################################################
    # 2. MODE 1: PACMAN CACHE ROLLBACK
    #####################################################################

    - name: Find cached kernel packages (mode 1)
      ansible.builtin.find:
        paths: "{{ pacman_cache }}"
        patterns: "linux-*.pkg.tar.zst"
      register: cached_pkgs
      when: rollback_mode == "1"

    - name: Fail if no cached kernel packages found (mode 1)
      ansible.builtin.fail:
        msg: "No cached kernel packages found in {{ pacman_cache }}."
      when:
        - rollback_mode == "1"
        - cached_pkgs.files | length == 0

    - name: Install previous kernel package(s) from pacman cache (mode 1)
      ansible.builtin.package:
        name: "{{ item.path }}"
        state: present
      loop: "{{ cached_pkgs.files }}"
      when: rollback_mode == "1"

    #####################################################################
    # 3. MODE 2: BACKUP DIRECTORY ROLLBACK
    #####################################################################

    - name: Restore /boot from backup (mode 2)
      ansible.builtin.synchronize:
        src: "{{ rollback_dir }}/boot/"
        dest: "{{ boot_dir }}/"
        recursive: yes
        delete: yes
      when: rollback_mode == "2"

    - name: Restore /usr/lib/modules from backup (mode 2)
      ansible.builtin.synchronize:
        src: "{{ rollback_dir }}/modules/"
        dest: "{{ modules_dir }}/"
        recursive: yes
        delete: yes
      when: rollback_mode == "2"

    #####################################################################
    # 4. REBOOT + SUMMARY
    #####################################################################

    - name: Reboot node after rollback
      ansible.builtin.reboot:
        msg: "Rebooting after kernel rollback"
      when: kernel_reboot_after_rollback | default(true) | bool

    - name: Display rollback confirmation
      ansible.builtin.debug:
        msg: >
          Kernel rollback completed on {{ inventory_hostname }}
          using mode {{ rollback_mode }}
          {{ rollback_mode == "2" | ternary("from " + rollback_dir, "from pacman cache") }}
