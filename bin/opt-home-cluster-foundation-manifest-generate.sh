#!/usr/bin/env bash
# =============================================================================
# File: /opt/ansible-k3s-cluster/bin/cluster-foundation-manifest-generate.sh
# =============================================================================
# Purpose:
#   Generate the canonical wc-based manifest for the cluster foundation files.
#   Output file:
#     /opt/ansible-k3s-cluster/manifest/cluster-foundation.manifest
#
# Coverage:
#   - /opt/ansible-k3s-cluster
#   - /home/builder/linux-rpi-k3s
#
# Behavior:
#   - Scans both framework roots.
#   - Excludes manifest directory, VCS directories, and temp files.
#   - Produces a sorted, deterministic list of:
#       <byte_count> <full_path>
#
# Notes:
#   - This script defines the authoritative manifest.
#   - Do not edit the manifest by hand.
# =============================================================================

set -euo pipefail

OPT_ROOT="/opt/ansible-k3s-cluster"
BUILDER_ROOT="/home/builder/linux-rpi-k3s"

MANIFEST_DIR="${OPT_ROOT}/manifest"
MANIFEST_FILE="${MANIFEST_DIR}/cluster-foundation.manifest"

mkdir -p "${MANIFEST_DIR}"

TMP_MANIFEST="$(mktemp "${MANIFEST_DIR}/cluster-foundation.manifest.tmp.XXXXXX")"

cat > "${TMP_MANIFEST}" <<'EOF'
# =============================================================================
# File: /opt/ansible-k3s-cluster/manifest/cluster-foundation.manifest
# =============================================================================
# Purpose:
#   Canonical manifest of the cluster foundation files.
#   Each line contains:
#     <byte_count> <full_path>
#
# Notes:
#   - Generated by cluster-foundation-manifest-generate.sh
#   - Do not edit by hand.
# =============================================================================
# bytes path
# -----------------------------------------------------------------------------
EOF

scan_root() {
  local root="$1"

  find "${root}" \
    -type f \
    ! -path "${OPT_ROOT}/manifest/*" \
    ! -path "${root}/.git/*" \
    ! -name "*.swp" \
    ! -name "*.tmp" \
    ! -name "*.bak" \
    | sort \
    | while read -r path; do
        bytes="$(wc -c < "${path}" | tr -d ' ')"
        printf "%s %s\n" "${bytes}" "${path}"
      done >> "${TMP_MANIFEST}"
}

scan_root "${OPT_ROOT}"
scan_root "${BUILDER_ROOT}"

mv "${TMP_MANIFEST}" "${MANIFEST_FILE}"

echo "Manifest generated: ${MANIFEST_FILE}"
