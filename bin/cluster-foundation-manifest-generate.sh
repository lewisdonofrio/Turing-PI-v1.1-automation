#!/usr/bin/env bash
# =============================================================================
# File: /opt/ansible-k3s-cluster/bin/cluster-foundation-manifest-generate.sh
# =============================================================================
# Purpose:
#   Generate the canonical wc-based manifest for the cluster foundation files.
#   Output file:
#     /opt/ansible-k3s-cluster/manifest/cluster-foundation.manifest
#
# Behavior:
#   - Scans the framework directories.
#   - Excludes temporary files, VCS directories, and the manifest directory
#     itself (to avoid self-reference).
#   - Produces a sorted, deterministic list of:
#       <byte_count> <full_path>
#
# Usage:
#   sudo bash /opt/ansible-k3s-cluster/bin/cluster-foundation-manifest-generate.sh
#
# Notes:
#   - Run this only when you intentionally change the framework.
#   - Verification should use the verify script, not regenerate this manifest.
# =============================================================================

set -euo pipefail

BASE_DIR="/opt/ansible-k3s-cluster"
MANIFEST_DIR="${BASE_DIR}/manifest"
MANIFEST_FILE="${MANIFEST_DIR}/cluster-foundation.manifest"

mkdir -p "${MANIFEST_DIR}"

# Temporary file to build the manifest before atomic move
TMP_MANIFEST="$(mktemp "${MANIFEST_DIR}/cluster-foundation.manifest.tmp.XXXXXX")"

# Write header
cat > "${TMP_MANIFEST}" <<'EOF'
# =============================================================================
# File: /opt/ansible-k3s-cluster/manifest/cluster-foundation.manifest
# =============================================================================
# Purpose:
#   Canonical manifest of the cluster foundation files.
#   Each line contains:
#     <byte_count> <full_path>
#
# Notes:
#   - Generated by cluster-foundation-manifest-generate.sh
#   - Do not edit by hand.
# =============================================================================
# bytes path
# -----------------------------------------------------------------------------
EOF

# Find all files under BASE_DIR that belong to the framework,
# excluding manifest directory itself, VCS, and obvious temp files.
find "${BASE_DIR}" \
  -type f \
  ! -path "${MANIFEST_DIR}/*" \
  ! -path "${BASE_DIR}/.git/*" \
  ! -name "*.swp" \
  ! -name "*.tmp" \
  ! -name "*.bak" \
  | sort \
  | while read -r path; do
      # Use wc -c for byte count; strip leading spaces and filename.
      bytes="$(wc -c < "${path}" | tr -d ' ')"
      printf "%s %s\n" "${bytes}" "${path}"
    done >> "${TMP_MANIFEST}"

# Atomic replace
mv "${TMP_MANIFEST}" "${MANIFEST_FILE}"

echo "Manifest generated: ${MANIFEST_FILE}"
