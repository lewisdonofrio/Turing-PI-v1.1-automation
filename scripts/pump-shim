#!/bin/sh
# file: /home/builder/scripts/pump-shim
# purpose: Launch include-server for pump-mode and hand off to real distcc.
# notes: Canonical shim for pump-mode on ArchLinuxARM. Must be kept in sync
#        with /opt/ansible-k3s-cluster/staging/home-scripts/pump-shim.
#        No tabs, ASCII-only.

set -eu

unset DISTCC_HOSTS || true

# Start include-server if not running
if ! pgrep -f include-server >/dev/null 2>&1; then
    BASE="/tmp/distcc-pump.$$"
    SOCKET="$BASE/socket"
    PIDFILE="$BASE/pid"

    mkdir -p "$BASE"

    include-server-wrapper \
        --port "$SOCKET" \
        --pid_file "$PIDFILE" &

    sleep 1

    export INCLUDE_SERVER_PORT="$SOCKET"
    export INCLUDE_SERVER_PID="$(cat "$PIDFILE")"
fi

exec /usr/bin/distcc "$@"
